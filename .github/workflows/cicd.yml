name: CI/CD Pipeline - Socrates-BE Deployment

on:
  push:
    branches: [ "main", "develop", "feature/cicd1" ]
  pull_request:
    branches: [ "main", "develop", "feature/cicd1" ]

env:
  AWS_REGION: ap-northeast-2
  ECS_CLUSTER: socrates-cluster
  CHAT_REPO: tf1/socrates-chat
  CHAT_SERVICE: socrates-chat-service
  CHAT_TASK: socrates-chat-task
  CHAT_CONTAINER: socrates-chat-container
  ANALYTICS_REPO: tf1/socrates-analytics
  ANALYTICS_SERVICE: socrates-analytics-service
  ANALYTICS_TASK: socrates-analytics-task
  ANALYTICS_CONTAINER: socrates-analytics-container

jobs:
  test:
    name: Test & Build Verification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      - name: Build all modules
        run: ./gradlew build --no-daemon -x test

  build-and-deploy-chat:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/feature/cicd1')
    steps:
      - uses: actions/checkout@v4
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push image
        id: build-image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./app-webflux-chat/Dockerfile
          push: true
          build-args: |
            MODULE=app-webflux-chat
            APP_PORT=8080
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.CHAT_REPO }}:latest
            ${{ steps.login-ecr.outputs.registry }}/${{ env.CHAT_REPO }}:${{ github.sha }}

      - name: Update ECS Task Definition
        if: github.ref == 'refs/heads/main'
        env:
          SERVER_PORT: ${{ secrets.CHAT_SERVER_PORT }}
          MONGODB_URI: ${{ secrets.CHAT_MONGODB_URI }}

        run: |
          # 기존 Task Definition 가져오기
          aws ecs describe-task-definition --task-definition ${{ env.CHAT_TASK }} --query taskDefinition > raw-task-def.json
          cat raw-task-def.json | jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)' > task-definition.json
          
          # 새 이미지로 업데이트
          NEW_IMAGE="${{ steps.login-ecr.outputs.registry }}/${{ env.CHAT_REPO }}:${{ github.sha }}"
          NEW_TASK_DEF=$(cat task-definition.json | jq --arg IMAGE "$NEW_IMAGE" '.containerDefinitions[0].image = $IMAGE')
          
          # GitHub Secrets에서 환경변수 설정
          NEW_TASK_DEF=$(echo "$NEW_TASK_DEF" | jq --arg SERVER_PORT "$SERVER_PORT" \
            --arg MONGODB_URI "$MONGODB_URI" \
            '.containerDefinitions[0].environment = [
              {"name": "SERVER_PORT", "value": $SERVER_PORT},
              {"name": "MONGODB_URI", "value": $MONGODB_URI},
            ] | map(select(.value != "" and .value != null))')
          
          echo "$NEW_TASK_DEF" > final-task-def.json
          NEW_TASK_INFO=$(aws ecs register-task-definition --cli-input-json file://final-task-def.json)
          NEW_REVISION=$(echo $NEW_TASK_INFO | jq '.taskDefinition.revision')
          
          # ECS Service 업데이트
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.CHAT_SERVICE }} \
            --task-definition ${{ env.CHAT_TASK }}:$NEW_REVISION \
            --force-new-deployment

  build-and-deploy-analytics:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/feature/cicd1')
    steps:
      - uses: actions/checkout@v4
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push image
        id: build-image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./app-mvc-analytics/Dockerfile
          push: true
          build-args: |
            MODULE=app-mvc-analytics
            APP_PORT=8081
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ANALYTICS_REPO }}:latest
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ANALYTICS_REPO }}:${{ github.sha }}

      - name: Update ECS Task Definition
        if: github.ref == 'refs/heads/main'
        env:
          SERVER_PORT: ${{ secrets.ANALYTICS_SERVER_PORT }}
        run: |
          # 기존 Task Definition 가져오기
          aws ecs describe-task-definition --task-definition ${{ env.ANALYTICS_TASK }} --query taskDefinition > raw-task-def.json
          cat raw-task-def.json | jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)' > task-definition.json
          
          # 새 이미지로 업데이트
          NEW_IMAGE="${{ steps.login-ecr.outputs.registry }}/${{ env.ANALYTICS_REPO }}:${{ github.sha }}"
          NEW_TASK_DEF=$(cat task-definition.json | jq --arg IMAGE "$NEW_IMAGE" '.containerDefinitions[0].image = $IMAGE')
          
          # GitHub Secrets에서 환경변수 설정 (필요한 경우)
          if [ -n "$SERVER_PORT" ]; then
            NEW_TASK_DEF=$(echo "$NEW_TASK_DEF" | jq --arg SERVER_PORT "$SERVER_PORT" \
              '.containerDefinitions[0].environment = [
                {"name": "SERVER_PORT", "value": $SERVER_PORT}
              ]')
          fi
          
          echo "$NEW_TASK_DEF" > final-task-def.json
          NEW_TASK_INFO=$(aws ecs register-task-definition --cli-input-json file://final-task-def.json)
          NEW_REVISION=$(echo $NEW_TASK_INFO | jq '.taskDefinition.revision')
          
          # ECS Service 업데이트
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ANALYTICS_SERVICE }} \
            --task-definition ${{ env.ANALYTICS_TASK }}:$NEW_REVISION \
            --force-new-deployment