name: CI/CD Pipeline - Socrates-BE Deployment

on:
  push:
    branches: [ "main", "feature/cicd1" ]

env:
  AWS_REGION: ap-northeast-2
  ECS_CLUSTER: hackerthon-cluster
  CHAT_REPO: tf1/socrates-chat
  CHAT_SERVICE: socrates-chat-task-service
  CHAT_TASK: socrates-chat-task
  ANALYTICS_REPO: tf1/socrates-analytics
  ANALYTICS_SERVICE: socrates-analytics-task-service
  ANALYTICS_TASK: socrates-analytics-task

jobs:
  test:
    name: Test & Build Verification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      - name: Build all modules
        # 테스트 실패로 인한 중단을 막기 위해 -x test 유지
        run: ./gradlew build --no-daemon -x test

  build-and-deploy-chat:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/feature/cicd1'
    steps:
      - uses: actions/checkout@v4
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push image
        id: build-image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./app-webflux-chat/Dockerfile
          push: true
          build-args: |
            MODULE=app-webflux-chat
            APP_PORT=8080
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.CHAT_REPO }}:latest
            ${{ steps.login-ecr.outputs.registry }}/${{ env.CHAT_REPO }}:${{ github.sha }}

      - name: Update ECS Service
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/feature/cicd1'
        env:
          SERVER_PORT: "8080"
          MONGODB_URI: ${{ secrets.CHAT_MONGODB_URI }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          FASTAPI_BASE_URL: ${{ secrets.FASTAPI_BASE_URL }}
        run: |
          aws ecs describe-task-definition --task-definition ${{ env.CHAT_TASK }} --query taskDefinition > raw-task-def.json
          cat raw-task-def.json | jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)' > task-definition.json
          
          NEW_IMAGE="${{ steps.login-ecr.outputs.registry }}/${{ env.CHAT_REPO }}:${{ github.sha }}"
          
          # JQ 문법 수정: 환경 변수 주입 로직 정밀화
          cat task-definition.json | jq --arg IMAGE "$NEW_IMAGE" \
            --arg SERVER_PORT "$SERVER_PORT" \
            --arg MONGODB_URI "$MONGODB_URI" \
            --arg OPENAI_API_KEY "$OPENAI_API_KEY" \
            --arg FASTAPI_BASE_URL "$FASTAPI_BASE_URL" \
            '.containerDefinitions[0].image = $IMAGE | 
             .containerDefinitions[0].environment = ([
               {"name": "SERVER_PORT", "value": $SERVER_PORT},
               {"name": "MONGODB_URI", "value": $MONGODB_URI},
               {"name": "OPENAI_API_KEY", "value": $OPENAI_API_KEY},
               {"name": "FASTAPI_BASE_URL", "value": $FASTAPI_BASE_URL}
             ] | map(select(.value != "" and .value != null and .value != "null")))' > final-task-def.json
          
          NEW_TASK_INFO=$(aws ecs register-task-definition --cli-input-json file://final-task-def.json)
          NEW_REVISION=$(echo $NEW_TASK_INFO | jq '.taskDefinition.revision')
          
          aws ecs update-service --cluster ${{ env.ECS_CLUSTER }} --service ${{ env.CHAT_SERVICE }} --task-definition ${{ env.CHAT_TASK }}:$NEW_REVISION --force-new-deployment

  build-and-deploy-analytics:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/feature/cicd1'
    steps:
      - uses: actions/checkout@v4
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push image
        id: build-image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./app-mvc-analytics/Dockerfile
          push: true
          build-args: |
            MODULE=app-mvc-analytics
            APP_PORT=8081
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ANALYTICS_REPO }}:latest
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ANALYTICS_REPO }}:${{ github.sha }}

      - name: Update ECS Service
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/feature/cicd1'
        env:
          SERVER_PORT: "8081"
          POSTGRESQL_URI: ${{ secrets.POSTGRESQL_URI }}
          POSTGRESQL_USERNAME: ${{ secrets.POSTGRESQL_USERNAME }}
          POSTGRESQL_PASSWORD: ${{ secrets.POSTGRESQL_PASSWORD }}
          MONGODB_URI: ${{ secrets.CHAT_MONGODB_URI }}
        run: |
          aws ecs describe-task-definition --task-definition ${{ env.ANALYTICS_TASK }} --query taskDefinition > raw-task-def.json
          cat raw-task-def.json | jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)' > task-definition.json
          
          NEW_IMAGE="${{ steps.login-ecr.outputs.registry }}/${{ env.ANALYTICS_REPO }}:${{ github.sha }}"
          
          cat task-definition.json | jq --arg IMAGE "$NEW_IMAGE" \
            --arg SERVER_PORT "$SERVER_PORT" \
            --arg POSTGRESQL_URI "$POSTGRESQL_URI" \
            --arg POSTGRESQL_USERNAME "$POSTGRESQL_USERNAME" \
            --arg POSTGRESQL_PASSWORD "$POSTGRESQL_PASSWORD" \
            --arg MONGODB_URI "$MONGODB_URI" \
            '.containerDefinitions[0].image = $IMAGE | 
             .containerDefinitions[0].environment = ([
               {"name": "SERVER_PORT", "value": $SERVER_PORT},
               {"name": "POSTGRESQL_URI", "value": $POSTGRESQL_URI},
               {"name": "POSTGRESQL_USERNAME", "value": $POSTGRESQL_USERNAME},
               {"name": "POSTGRESQL_PASSWORD", "value": $POSTGRESQL_PASSWORD},
               {"name": "MONGODB_URI", "value": $MONGODB_URI}
             ] | map(select(.value != "" and .value != null and .value != "null")))' > final-task-def.json
          
          NEW_TASK_INFO=$(aws ecs register-task-definition --cli-input-json file://final-task-def.json)
          NEW_REVISION=$(echo $NEW_TASK_INFO | jq '.taskDefinition.revision')
          
          aws ecs update-service --cluster ${{ env.ECS_CLUSTER }} --service ${{ env.ANALYTICS_SERVICE }} --task-definition ${{ env.ANALYTICS_TASK }}:$NEW_REVISION --force-new-deployment